---
// Mapã®ã‚³ãƒ³ãƒ†ãƒŠID
const mapContainerId = "map-container";
// åœ°å›³ã®ä¸­å¿ƒåº§æ¨™ (å¤§é˜ªåºœé«˜çŸ³å¸‚ç¾½è¡£å…¬åœ’ä¸)
const center: [number, number] = [135.4330025649711, 34.53298339064751];
// ã‚ºãƒ¼ãƒ ãƒ¬ãƒ™ãƒ«
const zoom: number = 16;
---

<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å˜ç‹¬ãƒãƒƒãƒ—è¡¨ç¤º</title>
    
    <link rel="stylesheet" href="https://unpkg.com/maplibre-gl/dist/maplibre-gl.css">
    <script src="https://unpkg.com/maplibre-gl/dist/maplibre-gl.js"></script>

    <style>
        body { margin: 0; padding: 0; }
        /* åœ°å›³ã‚’ç”»é¢ã„ã£ã±ã„ã«è¡¨ç¤ºã™ã‚‹ãŸã‚ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        #map-container { position: absolute; top: 0; bottom: 0; width: 100%; }
    </style>

    <link rel="stylesheet" href="https://unpkg.com/@maplibre/maplibre-gl-geocoder@1.2.0/dist/maplibre-gl-geocoder.css" type="text/css">
    <script src="https://unpkg.com/@maplibre/maplibre-gl-geocoder@1.2.0/dist/maplibre-gl-geocoder.min.js"></script>
</head>
<body>
    <main>
        <div id={mapContainerId}></div>

        <script define:vars={{ mapContainerId, center, zoom }} is:inline>
            
            // ãƒšãƒ¼ã‚¸å†…ã®ã™ã¹ã¦ã®è¦ç´ ï¼ˆå¤–éƒ¨ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’å«ã‚€ï¼‰ãŒèª­ã¿è¾¼ã¾ã‚ŒãŸå¾Œã«å®Ÿè¡Œã™ã‚‹
            window.onload = () => {
                
                const maplibregl = window.maplibregl;
                
                if (typeof maplibregl === 'undefined') {
                    console.error("MapLibre GL JSãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã›ã‚“ã€‚");
                    return;
                }
                
                // ------------------------------------
                // 1. åœ°å›³ã®åˆæœŸåŒ–
                // ------------------------------------
                const map = new maplibregl.Map({
                    container: mapContainerId,
                    style: 'https://api.maptiler.com/maps/streets-v4/style.json?key=QecJGOKNw0YEhbCJIvDw', 
                    center: center,
                    zoom: zoom
                });

                // ç¾åœ¨åœ°ãƒœã‚¿ãƒ³ã®è¿½åŠ 
                map.addControl(
                    new maplibregl.GeolocateControl({
                        positionOptions: { enableHighAccuracy: true },
                        trackUserLocation: true,
                        showUserHeading: true
                    })
                );
                
                // ãƒãƒ¼ã‚«ãƒ¼ã®è¿½åŠ 
                new maplibregl.Marker({ color: '#0000FF' })
                    .setLngLat(center)
                    .setPopup(
                        new maplibregl.Popup({ offset: 25 }) 
                            .setHTML("<h5>ãƒãƒ¼ã‚¯ã•ã‚ŒãŸå ´æ‰€</h5><p>é‡è¦ãªå°ã§ã™</p>")
                    )
                    .addTo(map);

                // ------------------------------------
                // 4. æ¤œç´¢ãƒãƒ¼ (Geocoder) ã®è¿½åŠ 
                // ------------------------------------

                // APIè¨­å®š
                const API_KEY = 'QecJGOKNw0YEhbCJIvDw';
                const geocoderApiUrl = `https://api.maptiler.com/geocoding/{query}.json?key=${API_KEY}`;

                // ğŸ’¡ Geocoderã‚¯ãƒ©ã‚¹ã®å®šç¾©ã‚’ã€ã‚°ãƒ­ãƒ¼ãƒãƒ«ã¾ãŸã¯ maplibregl ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‹ã‚‰æ¢ã™
                const GeocoderClass = window.MapLibreGeocoder || maplibregl.Geocoder;

                if (typeof GeocoderClass === 'undefined') {
                    console.error("MapLibreGeocoderãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¦ã„ã¾ã™ã€‚");
                    return;
                }
                
                // Geocoderã®åˆæœŸåŒ–
                const geocoder = new GeocoderClass(geocoderApiUrl, {
                    maplibregl: maplibregl, 
                    marker: {
                        color: '#ff0088'
                    },
                });

                // ãƒãƒƒãƒ—ã«æ¤œç´¢ãƒãƒ¼ã‚’å³ä¸Šã«é…ç½®
                map.addControl(geocoder, 'top-right'); 
            }; // window.onload çµ‚äº†
        </script>
    </main>
</body>
</html>